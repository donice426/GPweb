<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark" />
  <title>Acceso | Informe gpVision™</title>

  <style>
    :root{
      --bg1:#081726; --bg2:#0b2a44;
      --card: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.14);
      --text:#eaf2ff; --muted: rgba(234,242,255,.75);
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --r:16px;

      --gh-bg: rgba(255,255,255,.06);
      --gh-bg2: rgba(0,0,0,.18);
      --gh-stroke: rgba(255,255,255,.18);
      --gh-text: rgba(234,242,255,.92);
    }

    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; display:grid; place-items:center;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 15% 15%, rgba(42,167,255,.18), transparent 60%),
        radial-gradient(800px 400px at 85% 85%, rgba(42,167,255,.12), transparent 55%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
      padding:24px;
    }

    .card{
      width:min(430px, 100%);
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:calc(var(--r) + 2px);
      box-shadow:var(--shadow);
      padding:22px;
      backdrop-filter: blur(10px);
      position:relative;
      overflow:hidden;
    }

    .card::before{
      content:"";
      position:absolute; inset:-40% -30% auto -30%;
      height:220px;
      background: radial-gradient(closest-side, rgba(42,167,255,.18), transparent 70%);
      pointer-events:none;
    }

    .brand{
      display:flex; align-items:center; gap:12px; margin-bottom:16px;
      position:relative;
    }

    .logoWrap{
      width: 42px; height: 42px; border-radius: 14px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 10px 22px rgba(0,0,0,.25);
      overflow: hidden;
      flex: 0 0 auto;
    }
    .logoWrap img{ max-width:100%; max-height:100%; object-fit:contain; }

    h1{font-size:18px; margin:0; letter-spacing:.2px}
    p{margin:4px 0 0; color:var(--muted); font-size:13px; line-height:1.35}

    .actions{ margin-top:12px; display:grid; gap:10px; }

    .ghLink{
      width:100%;
      padding:12px 14px;
      border-radius:12px;
      border: 1px solid var(--gh-stroke);
      background: linear-gradient(135deg, var(--gh-bg), var(--gh-bg2));
      color: var(--gh-text);
      font-weight: 800;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      text-decoration:none;
      transition: filter .15s ease, transform .05s ease;
    }
    .ghLink:hover{ filter: brightness(1.08); }
    .ghLink:active{ transform: translateY(1px); }

    .ghMark{
      width:18px; height:18px;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.25));
    }

    .msg{
      margin-top:12px;
      font-size:13px;
      padding:10px 12px;
      border-radius:12px;
      display:none;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
    }
    .msg.error{
      display:block;
      border-color: rgba(255,77,77,.35);
      background: rgba(255,77,77,.10);
      color: #ffd0d0;
    }
    .msg.ok{
      display:block;
      border-color: rgba(69,212,131,.30);
      background: rgba(69,212,131,.10);
      color: #d8ffe9;
    }

    .smallRow{
      display:flex; justify-content:space-between; gap:10px;
      margin-top:8px; color: rgba(234,242,255,.62); font-size:12px;
    }

    .footer{
      margin-top:14px;
      font-size:11px;
      color: rgba(234,242,255,.55);
      text-align:center;
    }
  </style>
</head>

<body>
  <main class="card" id="card">
    <div class="brand">
      <div class="logoWrap">
        <img src="Imagenes/image-removebg-preview.ico" alt="GP Graders">
      </div>
      <div>
        <h1>Acceso restringido</h1>
        <p>Autentícate con GitHub para visualizar el informe técnico.</p>
      </div>
    </div>

    <div class="actions">
      <a id="ghLink" class="ghLink" href="#">
        <svg class="ghMark" viewBox="0 0 16 16" aria-hidden="true" fill="currentColor">
          <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8Z"/>
        </svg>
        Continuar con GitHub
      </a>

      <div class="smallRow">
        <span id="statusHint">Verificando sesión…</span>
      </div>

      <div id="msg" class="msg" aria-live="polite"></div>
    </div>

    <div class="footer">gpVision™ | Documentación interna</div>
  </main>

  <script>
    (async () => {
      const AUTH_BASE = "https://gpgraders-auth.donice426.workers.dev";
      const statusHint = document.getElementById("statusHint");
      const msg = document.getElementById("msg");
      const ghLink = document.getElementById("ghLink");

      function setMessage(text, type){
        msg.textContent = text;
        msg.className = "msg " + (type || "");
        msg.style.display = text ? "block" : "none";
      }

      // 1) Calcula "next" dinámico (misma carpeta -> menu.html)
      const here = new URL(location.href);
      const qp = here.searchParams;
      const nextParam = qp.get("next"); // si viene desde menu.html
      const nextPath = nextParam || here.pathname.replace(/\/[^\/]*$/, "/menu.html");

      // 2) Setea el link de OAuth
      ghLink.href = `${AUTH_BASE}/auth/start?next=${encodeURIComponent(nextPath)}`;

      // 3) Si vienes con error en querystring (opcional)
      const err = qp.get("error");
      if (err) setMessage(decodeURIComponent(err), "error");

      // 4) Si ya hay sesión, entra directo
      try{
        const res = await fetch(`${AUTH_BASE}/api/me`, { credentials: "include" });
        if (res.ok){
          const data = await res.json().catch(() => null);
          if (data && data.ok && data.user && data.user.login){
            statusHint.textContent = `Conectado como @${data.user.login}. Entrando…`;
            setTimeout(() => location.href = "menu.html", 200);
            return;
          }
        }
        statusHint.textContent = "Sin sesión. Inicia con GitHub.";
      }catch{
        statusHint.textContent = "Servicio de autenticación no disponible.";
        setMessage("No se pudo conectar al servicio de autenticación.", "error");
      }
    })();
  </script>
</body>
</html>
