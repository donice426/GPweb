<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark" />
  <title>Acceso | Informe gpVision™</title>

  <style>
    :root{
      --bg1:#081726; --bg2:#0b2a44;
      --card: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.14);
      --text:#eaf2ff; --muted: rgba(234,242,255,.75);
      --accent:#2aa7ff; --danger:#ff4d4d; --ok:#45d483;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --r:16px;
      --focus: 0 0 0 4px rgba(42,167,255,.14);

      /* GitHub button */
      --gh-bg: rgba(255,255,255,.06);
      --gh-bg2: rgba(0,0,0,.18);
      --gh-stroke: rgba(255,255,255,.18);
      --gh-text: rgba(234,242,255,.92);
    }

    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; display:grid; place-items:center;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 15% 15%, rgba(42,167,255,.18), transparent 60%),
        radial-gradient(800px 400px at 85% 85%, rgba(42,167,255,.12), transparent 55%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
      padding:24px;
    }

    .card{
      width:min(430px, 100%);
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:calc(var(--r) + 2px);
      box-shadow:var(--shadow);
      padding:22px;
      backdrop-filter: blur(10px);
      position:relative;
      overflow:hidden;
    }

    .card::before{
      content:"";
      position:absolute; inset:-40% -30% auto -30%;
      height:220px;
      background: radial-gradient(closest-side, rgba(42,167,255,.18), transparent 70%);
      pointer-events:none;
    }

    .brand{
      display:flex; align-items:center; gap:12px; margin-bottom:16px;
      position:relative;
    }

    .logoWrap{
      width: 42px;
      height: 42px;
      border-radius: 14px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 10px 22px rgba(0,0,0,.25);
      overflow: hidden;
      flex: 0 0 auto;
    }

    .logoWrap img{
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    h1{font-size:18px; margin:0; letter-spacing:.2px}
    p{margin:4px 0 0; color:var(--muted); font-size:13px; line-height:1.35}

    form{ position:relative; }

    .actions{
      margin-top:14px;
      display:grid;
      gap:10px;
    }

    button{
      width:100%;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.18);
      background: linear-gradient(135deg, rgba(42,167,255,.95), rgba(42,167,255,.55));
      color:#03101a;
      font-weight:800;
      cursor:pointer;
      transition: filter .15s ease, transform .05s ease, opacity .15s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }

    button:hover{filter:brightness(1.05)}
    button:active{ transform: translateY(1px); }
    button:disabled{
      opacity:.7;
      cursor:not-allowed;
      filter:saturate(.9);
    }

    /* GitHub button */
    .ghBtn{
      background: linear-gradient(135deg, var(--gh-bg), var(--gh-bg2));
      color: var(--gh-text);
      border: 1px solid var(--gh-stroke);
      font-weight: 800;
    }
    .ghBtn:hover{ filter: brightness(1.08); }
    .ghMark{
      width:18px; height:18px;
      display:inline-block;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.25));
    }

    .divider{
      display:flex;
      align-items:center;
      gap:12px;
      margin: 2px 0;
      color: rgba(234,242,255,.55);
      font-size: 12px;
    }
    .divider::before, .divider::after{
      content:"";
      height:1px;
      flex:1;
      background: rgba(255,255,255,.12);
    }

    .spinner{
      width:16px; height:16px;
      border-radius:999px;
      border:2px solid rgba(234,242,255,.18);
      border-top-color: rgba(234,242,255,.85);
      display:none;
      animation: spin .8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .msg{
      margin-top:12px;
      font-size:13px;
      padding:10px 12px;
      border-radius:12px;
      display:none;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
    }
    .msg.error{
      display:block;
      border-color: rgba(255,77,77,.35);
      background: rgba(255,77,77,.10);
      color: #ffd0d0;
    }
    .msg.ok{
      display:block;
      border-color: rgba(69,212,131,.30);
      background: rgba(69,212,131,.10);
      color: #d8ffe9;
    }

    .footer{
      margin-top:14px;
      font-size:11px;
      color: rgba(234,242,255,.55);
      text-align:center;
    }

    .shake{
      animation: shake .35s ease;
    }
    @keyframes shake{
      0%,100%{ transform: translateX(0); }
      20%{ transform: translateX(-6px); }
      40%{ transform: translateX(6px); }
      60%{ transform: translateX(-4px); }
      80%{ transform: translateX(4px); }
    }

    .smallRow{
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin-top:8px;
      color: rgba(234,242,255,.62);
      font-size:12px;
    }

    .srOnly{
      position:absolute;
      width:1px;height:1px;
      padding:0;margin:-1px;
      overflow:hidden;clip:rect(0,0,0,0);
      white-space:nowrap;border:0;
    }
  </style>
</head>

<body>
  <main class="card" id="card">
    <div class="brand">
      <div class="logoWrap">
        <img src="Imagenes/image-removebg-preview.ico" alt="GP Graders">
      </div>
      <div>
        <h1>Acceso restringido</h1>
        <p>Autentícate con GitHub para visualizar el informe técnico.</p>
      </div>
    </div>

    <form id="loginForm" autocomplete="off" novalidate>
      <div class="actions" style="margin-top:6px;">
        <button id="ghBtn" class="ghBtn" type="button">
          <svg class="ghMark" viewBox="0 0 16 16" aria-hidden="true" fill="currentColor">
            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8Z"/>
          </svg>
          <span id="ghText">Continuar con GitHub</span>
          <span class="spinner" id="ghSpin" aria-hidden="true"></span>
        </button>

        <div class="divider">Acceso mediante GitHub OAuth</div>
      </div>

      <div class="smallRow">
        <span class="hint" id="statusHint">Verificando sesión…</span>
        <span class="srOnly" id="a11yStatus" aria-live="polite"></span>
      </div>

      <div id="msg" class="msg" aria-live="polite"></div>
    </form>

    <div class="footer">gpVision™ | Documentación interna</div>
  </main>

  <script>
    // ========= CONFIG =========
    const AUTH_BASE = "https://gpgraders-auth.donice426.workers.dev";
    const NEXT_PATH = "/GPweb/menu.html"; // ruta en GitHub Pages a la que volver
    const MENU_URL  = "menu.html";        // archivo local (relativo) dentro de /GPweb/

    // ========= UI =========
    const msg = document.getElementById("msg");
    const card = document.getElementById("card");
    const ghBtn = document.getElementById("ghBtn");
    const ghSpin = document.getElementById("ghSpin");
    const ghText = document.getElementById("ghText");
    const statusHint = document.getElementById("statusHint");
    const a11yStatus = document.getElementById("a11yStatus");

    function setMessage(text, type){
      msg.textContent = text;
      msg.className = "msg " + (type || "");
      msg.style.display = text ? "block" : "none";
      a11yStatus.textContent = text || "";
    }

    function shake(){
      card.classList.remove("shake"); void card.offsetWidth; card.classList.add("shake");
    }

    function setGhLoading(on){
      // IMPORTANTE: no deshabilitamos antes de navegar para evitar bloqueos de algunos browsers
      ghSpin.style.display = on ? "inline-block" : "none";
      ghText.textContent = on ? "Conectando…" : "Continuar con GitHub";
    }

    async function checkSession(){
      try{
        const res = await fetch(`${AUTH_BASE}/api/me`, { credentials: "include" });
        if (!res.ok) return null;
        const data = await res.json();
        return data && data.ok ? data.user : null;
      }catch{
        return null;
      }
    }

    // 1) Si ya hay sesión, entra directo
    (async () => {
      const user = await checkSession();
      if (user){
        setMessage(`Sesión activa como @${user.login}. Redirigiendo…`, "ok");
        statusHint.textContent = `Conectado como @${user.login}`;
        setTimeout(() => location.href = MENU_URL, 250);
        return;
      }
      statusHint.textContent = "Sin sesión. Inicia con GitHub.";
      setMessage("", "");
    })();

    // 2) Iniciar OAuth (NAVEGACIÓN DIRECTA)
    ghBtn.addEventListener("click", () => {
      setGhLoading(true);
      setMessage("Abriendo GitHub para autenticar…", "ok");

      const next = encodeURIComponent(NEXT_PATH);
      const startUrl = `${AUTH_BASE}/auth/start?next=${next}`;

      // Navegación directa y confiable
      location.assign(startUrl);
    });

    // 3) Si algo falla
    window.addEventListener("error", () => {
      setMessage("Ocurrió un error en la página de login.", "error");
      shake();
      setGhLoading(false);
    });

    window.addEventListener("unhandledrejection", () => {
      setMessage("No se pudo conectar al servicio de autenticación.", "error");
      shake();
      setGhLoading(false);
    });
  </script>
</body>
</html>
